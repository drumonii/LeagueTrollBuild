<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head></head>
<body>
<script th:fragment="script">
/*<![CDATA[*/
$(function() {
    $('#items-difference').DataTable({
        order: [ [1, 'asc'] ],
        columnDefs: [
            { orderable: false, targets: [0] },
            { searchable: false, targets: [0] }
        ],
        lengthMenu: [ [10, 25, 50, 100, -1], [10, 25, 50, 100, 'All'] ],
        language: {
            zeroRecords: [[#{dataTables.zeroRecords(#{admin.items})}]]
        },
        drawCallback: function(settings) {
            $('.item-description').popup();
        }
    });
    $('#save-items-form').submit(function(event) {
        var button = $('#save-items-btn');
        button.popup({
            on: 'click',
            inline: true
        });
        $.ajax({
            type: 'POST',
            url: [[@{/riot/items}]],
            beforeSend: function() {
                button.addClass('loading');
            },
            data: {
                truncate: $('#truncate').is(':checked'),
                [[${_csrf.parameterName}]]: [[${_csrf.token}]]
            },
            headers: {
                _csrf_header: [[${_csrf.headerName}]]
            },
            success: function(data) {
                location.reload();
            },
            error: function() {
                button.popup('show');
            },
            complete: function() {
                button.removeClass('loading');
            }
        });
        event.preventDefault();
    });
    var dataTable = $('#items').DataTable({
        processing: true,
        serverSide: true,
        order: [ [1, 'asc'] ],
        ajax: {
            url: [[@{/api/items}]],
            dataSrc: function(data) {
                if (typeof data._embedded === 'undefined') {
                    return {};
                }
                return data._embedded.items;
            },
            data: function(data) {
                var sorts = [];
                $.each(data.order, function(i, order) {
                    if (data.columns[order.column].orderable) {
                        sorts.push(data.columns[order.column].data + ',' + order.dir);
                    }
                });
                var parameters = {};
                if (data.search.value) {
                    parameters['term'] = data.search.value;
                }
                parameters['page'] = Math.ceil(data.start / data.length);
                parameters['size'] = data.length;
                parameters['sort'] = sorts;
                return $.param(parameters, true);
            }
        },
        columnDefs: [
            { orderable: false, targets: [0, 4, 5] }
        ],
        columns: [
            { data: null,
                render: function(data, type, full, meta) {
                    return $('<div>', {
                        class: 'item-description',
                        'data-html': data.description,
                        'data-variation': 'wide'
                    }).append($('<img>', {
                        class: 'ui rounded image',
                        src: '/resources/' + data.image.full
                    })).wrap('<span>').parent().html();
                }
            },
            { data: 'name' },
            { data: 'group' },
            { data: 'requiredChampion' },
            { data: '_links.self.href',
                render: function(data, type, full, meta) {
                    var button = $('<button>', {
                        'data-item-id': data.substring(data.lastIndexOf('/') + 1, data.length),
                        class: 'ui secondary button',
                        text: [[#{admin.item.overwrite}]]
                    });
                    var popup = $('<div>', {
                        class: 'ui negative message hidden popup',
                    }).wrapInner($('<p>').append($('<i>', {
                        class: 'warning circle icon'
                    })).append($('<span>', {
                        text: [[#{admin.item.overwrite.error}]]
                    })));
                    return button.wrap('<span>').parent().html() + popup.wrap('<span>').parent().html();
                }
            },
            { data: '_links.self.href',
                render: function(data, type, full, meta) {
                    var button = $('<button>', {
                        'data-item-id': data.substring(data.lastIndexOf('/') + 1, data.length),
                        class: 'negative ui button',
                        text: [[#{admin.item.delete}]]
                    });
                    var popup = $('<div>', {
                        class: 'ui negative message hidden popup',
                    }).wrapInner($('<p>').append($('<i>', {
                        class: 'warning circle icon'
                    })).append($('<span>', {
                        text: [[#{admin.item.delete.error}]]
                    })));
                    return button.wrap('<span>').parent().html() + popup.wrap('<span>').parent().html();
                }
            }
        ],
        lengthMenu: [ [10, 25, 50, 100, -1], [10, 25, 50, 100, 'All'] ],
        infoCallback: function(settings, start, end, max, total, pre) {
            var json = this.api().ajax.json();
            if (typeof json._embedded === 'undefined') {
                $('#items_paginate span').empty();
                return [[#{dataTables.noResults}]];
            }
            var page = this.api().ajax.json().page;
            end = (page.number + 1) * page.size;
            if (end > page.totalElements) {
                end = page.totalElements;
            }
            var msg = [[#{dataTables.showing}]];
            var args = [start, end, json._embedded.items.length, page.totalElements];
            return msg.replace(/{(\d+)}/g, function(match, number) {
                return typeof args[number] != 'undefined' ? args[number] : match;
            });
        },
        language: {
            zeroRecords: [[#{dataTables.zeroRecords(#{admin.items})}]]
        },
        drawCallback: function(settings) {
            $('.item-description').popup();
        }
    });
    dataTable.on('search.dt', function() {
        if ($('#items_filter input').val()) {
            dataTable.ajax.url([[@{/api/items/search/find-by}]]);
        } else {
            dataTable.ajax.url([[@{/api/items}]]);
        }
    });
    $('#items tbody').on('click', '.secondary', function(event) {
        $(event.target).popup({
            on: 'click',
            inline: true
        });
        $.ajax({
            type: 'POST',
            url: [[@{/riot/items}]] + '/' + $(this).data('item-id'),
            beforeSend: function() {
                $(event.target).addClass('loading');
            },
            data: {
                [[${_csrf.parameterName}]]: [[${_csrf.token}]]
            },
            headers: {
                _csrf_header: [[${_csrf.headerName}]]
            },
            success: function(data) {
                location.reload();
            },
            error: function() {
                $(event.target).popup('show');
            },
            complete: function() {
                $(event.target).removeClass('loading');
            }
        });
    });
    $('#items tbody').on('click', '.negative', function(event) {
        $(event.target).popup({
            on: 'click',
            inline: true
        });
        $.ajax({
            type: 'DELETE',
            url: [[@{/api/items}]] + '/' + $(this).data('item-id'),
            beforeSend: function() {
                $(event.target).addClass('loading');
            },
            headers: {
                [[${_csrf.headerName}]]: [[${_csrf.token}]]
            },
            success: function(data) {
                location.reload();
            },
            error: function() {
                $(event.target).popup('show');
            },
            complete: function() {
                $(event.target).removeClass('loading');
            }
        });
    });
    $('#difference-msg').click(function() {
        $(this).transition('fade');
    });
});
/*]]>*/
</script>
</body>
</html>