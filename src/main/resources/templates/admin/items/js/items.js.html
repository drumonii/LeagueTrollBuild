<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head></head>
<body>
<script th:inline="javascript" th:fragment="script">
/*<![CDATA[*/
$(function() {
    // Items difference
    var differenceDataTable = $('#items-difference').DataTable({
        order: [ [1, 'asc'] ],
        ajax: {
            url: [[@{/admin/items/diff}]],
            dataSrc: ''
        },
        columnDefs: [
            { orderable: false, targets: [0, 4, 5] },
            { searchable: false, targets: [0, 4, 5] }
        ],
        columns: [
            { data: null,
                render: function(data, type, full, meta) {
                    return $('<img>', {
                        'class': 'ui rounded image',
                        style: 'height:60px;width:auto;',
                        src: 'https://ddragon.leagueoflegends.com/cdn/' + [[${latestSavedPatch}]] + '/img/item/' +
                        data.image.full,
                    }).wrap('<span>').parent().html();
                }
            },
            { data: 'name' },
            { data: 'group',
                render: function(data, type, full, meta) {
                    if (data) {
                        return data;
                    }
                    return [[#{none}]];
                }
            },
            { data: 'requiredChampion',
                render: function(data, type, full, meta) {
                    if (data) {
                        return data;
                    }
                    return [[#{none}]];
                }
            },
            { data: 'maps',
                render: function(data, type, full, meta) {
                    var maps = [];
                    $.each(data, function(index, value) {
                        if (value) {
                            switch(index) {
                                case '8':
                                    maps.push(' The Crystal Scar');
                                    break;
                                case '10':
                                    maps.push(' Twisted Treeline');
                                    break;
                                case '11':
                                    maps.push(' Summoner’s Rift');
                                    break;
                                case '12':
                                    maps.push(' Howling Abyss');
                                break;
                            }
                        }
                    });
                    maps.sort();
                    return maps;
                }
            },
            { data: null,
                render: function(data, type, full, meta) {
                    var button = $('<button>', {
                        'data-item-id': data.id,
                        'class': 'ui fluid primary button',
                        style: 'box-sizing:border-box;',
                        text: [[#{admin.item.save}]]
                    });
                    return button.wrap('<span>').parent().html();
                }
            }
        ],
        lengthMenu: [ [10, 25, 50, 100, -1], [10, 25, 50, 100, 'All'] ],
        language: {
            emptyTable: [[#{dataTables.emptyTable(#{admin.items})}]],
            info: [[#{dataTables.info}]],
            infoEmpty: [[#{dataTables.infoEmpty}]],
            infoFiltered: [[#{dataTables.infoFiltered}]],
            processing: [[#{dataTables.processing}]],
            search: [[#{dataTables.search}]],
            zeroRecords: [[#{dataTables.zeroRecords(#{admin.items})}]],
            paginate: {
                next: [[#{dataTables.paginate.next}]],
                previous: [[#{dataTables.paginate.previous}]]
            }
        },
        drawCallback: function(settings) {
            $('.item-description').popup();
        }
    });
    $('.items-difference-search-input').keyup(function() {
        differenceDataTable.column($(this).data('column-index')).search($(this).val()).draw();
    });
    $('#items-difference tbody').on('click', '.primary', function(event) {
        $.ajax({
            type: 'POST',
            url: [[@{/riot/items/}]] + $(this).data('item-id'),
            beforeSend: function() {
                $(event.target).addClass('loading');
            },
            data: {
                [[${_csrf.parameterName}]]: [[${_csrf.token}]]
            },
            headers: {
                _csrf_header: [[${_csrf.headerName}]]
            },
            success: function(data) {
                $('#items-difference-error-msg').removeClass('visible').addClass('hidden');
                differenceDataTable.ajax.reload();
                dataTable.ajax.reload();
            },
            error: function() {
                $(event.target).removeClass('loading');
                $('#items-difference-error-msg .header').text([[#{admin.item.save.error}]]);
                $('#items-difference-error-msg').removeClass('hidden').addClass('visible');
            },
            complete: function() {
                $(event.target).removeClass('loading');
            }
        });
    });
    $('#save-items-form').submit(function(event) {
        $.ajax({
            type: 'POST',
            url: [[@{/riot/items}]],
            beforeSend: function() {
                $('#save-items-btn').addClass('loading');
            },
            data: {
                truncate: $('#truncate').is(':checked'),
                [[${_csrf.parameterName}]]: [[${_csrf.token}]]
            },
            headers: {
                _csrf_header: [[${_csrf.headerName}]]
            },
            success: function(data) {
                $('#items-difference-error-msg').removeClass('visible').addClass('hidden');
                differenceDataTable.ajax.reload();
                dataTable.ajax.reload();
            },
            error: function() {
                $('#save-items-btn').removeClass('loading');
                $('#items-difference-error-msg .header').text([[#{admin.items.save.error}]]);
                $('#items-difference-error-msg').removeClass('hidden').addClass('visible');
            },
            complete: function() {
                $('#save-items-btn').removeClass('loading');
            }
        });
        event.preventDefault();
    });
    differenceDataTable.on('xhr', function() {
        if ($.isEmptyObject(differenceDataTable.ajax.json())) {
            $('#items-difference-segment').slideUp();
        } else {
            $('#items-difference-segment').slideDown();
        }
    });
    // Items from the db
    var dataTable = $('#items').DataTable({
        processing: true,
        serverSide: true,
        order: [ [1, 'asc'] ],
        ajax: function(data, callback, settings) {
            var sorts = [];
            $.each(data.order, function (i, order) {
                if (data.columns[order.column].orderable) {
                    sorts.push(data.columns[order.column].data + ',' + order.dir);
                }
            });
            var parameters = {};
            if (data.search.value) {
                var searches = data.search.value.split(',');
                $.each(searches, function(index, value) {
                    var search = value.split('|');
                    parameters[search[0]] = search[1];
                });
            }
            parameters['page'] = Math.ceil(data.start / data.length);
            parameters['size'] = data.length;
            parameters['sort'] = sorts;
            $.get([[@{/api/items}]], $.param(parameters, true), function(json) {
                    callback({ draw: data.draw, recordsTotal: json.page.totalElements,
                        recordsFiltered: json.page.totalElements,
                        data: json._embedded === undefined ? {} : json._embedded.items
                    });
                }
            );
        },
        columnDefs: [
            { orderable: false, targets: [0, 4, 5, 6] }
        ],
        columns: [
            { data: null,
                render: function(data, type, full, meta) {
                    return $('<div>', {
                        'class': 'item-description',
                        'data-html': data.description,
                        'data-variation': 'wide'
                    }).append($('<img>', {
                        'class': 'ui rounded image',
                        src: '/img/items/' + data.image.full
                    })).wrap('<span>').parent().html();
                }
            },
            { data: 'name' },
            { data: 'group',
                render: function(data, type, full, meta) {
                    if (data) {
                        return data;
                    }
                    return [[#{none}]];
                }
            },
            { data: 'requiredChampion',
                render: function(data, type, full, meta) {
                    if (data) {
                        return data;
                    }
                    return [[#{none}]];
                }
            },
            { data: 'maps',
                render: function(data, type, full, meta) {
                    var maps = [];
                    $.each(data, function(index, value) {
                        if (value) {
                            switch(index) {
                                case '8':
                                    maps.push(' The Crystal Scar');
                                    break;
                                case '10':
                                    maps.push(' Twisted Treeline');
                                    break;
                                case '11':
                                    maps.push(' Summoner’s Rift');
                                    break;
                                case '12':
                                    maps.push(' Howling Abyss');
                                    break;
                            }
                        }
                    });
                    maps.sort();
                    return maps;
                }
            },
            { data: '_links.self.href',
                render: function(data, type, full, meta) {
                    var button = $('<button>', {
                        'data-item-id': data.substring(data.lastIndexOf('/') + 1, data.length),
                        'class': 'ui secondary button',
                        text: [[#{admin.item.overwrite}]]
                    });
                    return button.wrap('<span>').parent().html();
                }
            },
            { data: '_links.self.href',
                render: function(data, type, full, meta) {
                    var button = $('<button>', {
                        'data-item-id': data.substring(data.lastIndexOf('/') + 1, data.length),
                        'class': 'negative ui button',
                        text: [[#{admin.item.delete}]]
                    });
                    return button.wrap('<span>').parent().html();
                }
            }
        ],
        lengthMenu: [ [10, 25, 50, 100, 1000], [10, 25, 50, 100, 'All'] ],
        language: {
            emptyTable: [[#{dataTables.emptyTable(#{admin.items})}]],
            info: [[#{dataTables.info}]],
            infoEmpty: [[#{dataTables.infoEmpty}]],
            infoFiltered: [[#{dataTables.infoFiltered}]],
            processing: [[#{dataTables.processing}]],
            search: [[#{dataTables.search}]],
            zeroRecords: [[#{dataTables.zeroRecords(#{admin.items})}]],
            paginate: {
                next: [[#{dataTables.paginate.next}]],
                previous: [[#{dataTables.paginate.previous}]]
            }
        },
        drawCallback: function(settings) {
            $('.item-description').popup();
        }
    });
    $('.items-search-input').keyup(function() {
        var inputs = [];
        $('.items-search-input').each(function() {
            if ($(this).val()) {
                inputs.push($(this).data('column-name') + '|' + $(this).val());
            }
        });
        dataTable.search(inputs).draw();
    });
    $('#items tbody').on('click', '.secondary', function(event) {
        $.ajax({
            type: 'POST',
            url: [[@{/riot/items/}]] + $(this).data('item-id'),
            beforeSend: function() {
                $(event.target).addClass('loading');
            },
            data: {
                [[${_csrf.parameterName}]]: [[${_csrf.token}]]
            },
            headers: {
                _csrf_header: [[${_csrf.headerName}]]
            },
            success: function(data) {
                $('#items-error-msg').removeClass('visible').addClass('hidden');
                dataTable.ajax.reload();
            },
            error: function() {
                $(event.target).removeClass('loading');
                $('#items-error-msg .header').text([[#{admin.item.overwrite.error}]]);
                $('#items-error-msg').removeClass('hidden').addClass('visible');
            },
            complete: function() {
                $(event.target).removeClass('loading');
            }
        });
    });
    $('#items tbody').on('click', '.negative', function(event) {
        $.ajax({
            type: 'DELETE',
            url: [[@{/api/items/}]] + $(this).data('item-id'),
            beforeSend: function() {
                $(event.target).addClass('loading');
            },
            headers: {
                [[${_csrf.headerName}]]: [[${_csrf.token}]]
            },
            success: function(data) {
                $('#items-error-msg').removeClass('visible').addClass('hidden');
                differenceDataTable.ajax.reload();
                dataTable.ajax.reload();
            },
            error: function() {
                $(event.target).removeClass('loading');
                $('#items-error-msg .header').text([[#{admin.item.delete.error}]]);
                $('#items-error-msg').removeClass('hidden').addClass('visible');
            },
            complete: function() {
                $(event.target).removeClass('loading');
            }
        });
    });
    $('.message').click(function() {
        $(this).transition('fade');
    });
});
/*]]>*/
</script>
</body>
</html>